-- -- 创建辅助函数用于金额单位转换（亿元）
-- CREATE OR ALTER FUNCTION dbo.ToHundredMillion(@value decimal(18,2))
-- RETURNS decimal(18,2)
-- AS
-- BEGIN
--     RETURN ISNULL(@value, 0) / 100000000.0
-- END
-- GO

-- -- 创建辅助函数用于计算占比
-- CREATE OR ALTER FUNCTION dbo.CalculatePercentage(@value decimal(18,2), @total decimal(18,2))
-- RETURNS decimal(18,2)
-- AS
-- BEGIN
--     RETURN CASE WHEN ISNULL(@total, 0) = 0 THEN 0 
--            ELSE ISNULL(@value, 0) / @total * 100.0 
--            END
-- END
-- GO

-- 总部成本结构分析报表
IF @buguid IS NULL OR @buguid = '11B11DB4-E907-4F1F-8835-B9DAAB6E1F23'
BEGIN 
    WITH BaseData AS (
        -- 基础数据
        SELECT 
            项目分期分类,
            ISNULL(总成本情况_动态成本, 0) AS 总成本情况_动态成本,
            ISNULL(结算_已结算最新合约规划金额, 0) AS 结算_已结算最新合约规划金额,
            ISNULL(结算_结算金额, 0) AS 结算_结算金额,
            ISNULL(总价合同_首次签约为总价包干_最新合约规划金额, 0) AS 总价合同_首次签约为总价包干_最新合约规划金额,
            ISNULL(总价合同_首次签约为单价合同_目前已转总_最新合约规划金额, 0) AS 总价合同_首次签约为单价合同_目前已转总_最新合约规划金额,
            ISNULL(单价合同_首次签约为单价合同且未完成转总_最新合约规划金额, 0) AS 单价合同_首次签约为单价合同且未完成转总_最新合约规划金额,
            ISNULL(总价合同_首次签约为总价包干_预留金待发生, 0) AS 总价合同_首次签约为总价包干_预留金待发生,
            ISNULL(总价合同_首次签约为单价合同_目前已转总_预留金待发生, 0) AS 总价合同_首次签约为单价合同_目前已转总_预留金待发生,
            ISNULL(单价合同_首次签约为单价合同且未完成转总_预留金待发生, 0) AS 单价合同_首次签约为单价合同且未完成转总_预留金待发生,
            ISNULL(待签约_合约规划金额, 0) AS 待签约_合约规划金额,
            ISNULL(待签约_待发生预留金, 0) AS 待签约_待发生预留金,
            ISNULL(预留金_待发生预留金, 0) AS 预留金_待发生预留金,
            ISNULL(合同签订情况_未结算的已签合同金额, 0) AS 合同签订情况_未结算的已签合同金额,
            公司GUID,
            公司名称
        FROM cb
        WHERE (@buguid = '11B11DB4-E907-4F1F-8835-B9DAAB6E1F23' OR -- 总部查询时返回所有数据
               (@buguid IS NOT NULL AND 公司GUID = @buguid)) -- 平台公司查询时只返回对应公司数据
    ),
    PhaseCount AS (
        -- 分期数统计
        SELECT 
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率等于100%' THEN 1 ELSE 0 END) AS 已竣备完成_分期数,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率95%至100%' THEN 1 ELSE 0 END) AS 已竣备95至100_分期数,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率小于95%' THEN 1 ELSE 0 END) AS 已竣备小于95_分期数,
            SUM(CASE WHEN 项目分期分类 = '本年计划竣备分期' THEN 1 ELSE 0 END) AS 本年计划竣备_分期数,
            SUM(CASE WHEN 项目分期分类 = '在建分期' THEN 1 ELSE 0 END) AS 在建_分期数,
            SUM(CASE WHEN 项目分期分类 = '本年新开工' THEN 1 ELSE 0 END) AS 本年新开工_分期数,
            SUM(CASE WHEN 项目分期分类 = '未开工' THEN 1 ELSE 0 END) AS 未开工_分期数,
            SUM(CASE WHEN 项目分期分类 IS NOT NULL THEN 1 ELSE 0 END) AS 分期数合计
        FROM BaseData
    ),
    DynamicCost AS (
        -- 动态成本统计
        SELECT 
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率等于100%' THEN 总成本情况_动态成本 ELSE 0 END) AS 已竣备完成_动态成本,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率95%至100%' THEN 总成本情况_动态成本 ELSE 0 END) AS 已竣备95至100_动态成本,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率小于95%' THEN 总成本情况_动态成本 ELSE 0 END) AS 已竣备小于95_动态成本,
            SUM(CASE WHEN 项目分期分类 = '本年计划竣备分期' THEN 总成本情况_动态成本 ELSE 0 END) AS 本年计划竣备_动态成本,
            SUM(CASE WHEN 项目分期分类 = '在建分期' THEN 总成本情况_动态成本 ELSE 0 END) AS 在建_动态成本,
            SUM(CASE WHEN 项目分期分类 = '本年新开工' THEN 总成本情况_动态成本 ELSE 0 END) AS 本年新开工_动态成本,
            SUM(CASE WHEN 项目分期分类 = '未开工' THEN 总成本情况_动态成本 ELSE 0 END) AS 未开工_动态成本,
            SUM(CASE WHEN 项目分期分类 IS NOT NULL THEN 总成本情况_动态成本 ELSE 0 END) AS 动态成本合计
        FROM BaseData
    ),
    UnsettledContract AS (
        -- 已签约未结算合约成本统计
        SELECT 
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率等于100%' 
                THEN 总价合同_首次签约为总价包干_最新合约规划金额 + 
                     总价合同_首次签约为单价合同_目前已转总_最新合约规划金额 + 
                     单价合同_首次签约为单价合同且未完成转总_最新合约规划金额 
                ELSE 0 END) AS 已竣备完成_未结算,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率95%至100%' 
                THEN 总价合同_首次签约为总价包干_最新合约规划金额 + 
                     总价合同_首次签约为单价合同_目前已转总_最新合约规划金额 + 
                     单价合同_首次签约为单价合同且未完成转总_最新合约规划金额 
                ELSE 0 END) AS 已竣备95至100_未结算,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率小于95%' 
                THEN 总价合同_首次签约为总价包干_最新合约规划金额 + 
                     总价合同_首次签约为单价合同_目前已转总_最新合约规划金额 + 
                     单价合同_首次签约为单价合同且未完成转总_最新合约规划金额 
                ELSE 0 END) AS 已竣备小于95_未结算,
            SUM(CASE WHEN 项目分期分类 = '本年计划竣备分期' 
                THEN 总价合同_首次签约为总价包干_最新合约规划金额 + 
                     总价合同_首次签约为单价合同_目前已转总_最新合约规划金额 + 
                     单价合同_首次签约为单价合同且未完成转总_最新合约规划金额 
                ELSE 0 END) AS 本年计划竣备_未结算,
            SUM(CASE WHEN 项目分期分类 = '在建分期' 
                THEN 总价合同_首次签约为总价包干_最新合约规划金额 + 
                     总价合同_首次签约为单价合同_目前已转总_最新合约规划金额 + 
                     单价合同_首次签约为单价合同且未完成转总_最新合约规划金额 
                ELSE 0 END) AS 在建_未结算,
            SUM(CASE WHEN 项目分期分类 = '本年新开工' 
                THEN 总价合同_首次签约为总价包干_最新合约规划金额 + 
                     总价合同_首次签约为单价合同_目前已转总_最新合约规划金额 + 
                     单价合同_首次签约为单价合同且未完成转总_最新合约规划金额 
                ELSE 0 END) AS 本年新开工_未结算,
            SUM(CASE WHEN 项目分期分类 = '未开工' 
                THEN 合同签订情况_未结算的已签合同金额 
                ELSE 0 END) AS 未开工_未结算,
            SUM(CASE WHEN 项目分期分类 IS NOT NULL 
                THEN CASE WHEN 项目分期分类 = '未开工' 
                         THEN 合同签订情况_未结算的已签合同金额
                         ELSE 总价合同_首次签约为总价包干_最新合约规划金额 + 
                              总价合同_首次签约为单价合同_目前已转总_最新合约规划金额 + 
                              单价合同_首次签约为单价合同且未完成转总_最新合约规划金额 
                    END
                ELSE 0 END) AS 未结算合计
        FROM BaseData
    ),
    ReserveFund AS (
        -- 预留金统计
        SELECT 
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率等于100%' 
                THEN 总价合同_首次签约为总价包干_预留金待发生 + 
                     总价合同_首次签约为单价合同_目前已转总_预留金待发生 + 
                     单价合同_首次签约为单价合同且未完成转总_预留金待发生 
                ELSE 0 END) AS 已竣备完成_预留金,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率95%至100%' 
                THEN 总价合同_首次签约为总价包干_预留金待发生 + 
                     总价合同_首次签约为单价合同_目前已转总_预留金待发生 + 
                     单价合同_首次签约为单价合同且未完成转总_预留金待发生 
                ELSE 0 END) AS 已竣备95至100_预留金,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率小于95%' 
                THEN 总价合同_首次签约为总价包干_预留金待发生 + 
                     总价合同_首次签约为单价合同_目前已转总_预留金待发生 + 
                     单价合同_首次签约为单价合同且未完成转总_预留金待发生 
                ELSE 0 END) AS 已竣备小于95_预留金,
            SUM(CASE WHEN 项目分期分类 = '本年计划竣备分期' 
                THEN 总价合同_首次签约为总价包干_预留金待发生 + 
                     总价合同_首次签约为单价合同_目前已转总_预留金待发生 + 
                     单价合同_首次签约为单价合同且未完成转总_预留金待发生 
                ELSE 0 END) AS 本年计划竣备_预留金,
            SUM(CASE WHEN 项目分期分类 = '在建分期' 
                THEN 总价合同_首次签约为总价包干_预留金待发生 + 
                     总价合同_首次签约为单价合同_目前已转总_预留金待发生 + 
                     单价合同_首次签约为单价合同且未完成转总_预留金待发生 
                ELSE 0 END) AS 在建_预留金,
            SUM(CASE WHEN 项目分期分类 = '本年新开工' 
                THEN 总价合同_首次签约为总价包干_预留金待发生 + 
                     总价合同_首次签约为单价合同_目前已转总_预留金待发生 + 
                     单价合同_首次签约为单价合同且未完成转总_预留金待发生 
                ELSE 0 END) AS 本年新开工_预留金,
            0 AS 未开工_预留金,
            SUM(CASE WHEN 项目分期分类 IS NOT NULL AND 项目分期分类 <> '未开工'
                THEN 总价合同_首次签约为总价包干_预留金待发生 + 
                     总价合同_首次签约为单价合同_目前已转总_预留金待发生 + 
                     单价合同_首次签约为单价合同且未完成转总_预留金待发生 
                ELSE 0 END) AS 预留金合计
        FROM BaseData
    )
    -- 最终结果查询
    SELECT
        CASE 
            WHEN @buguid = '11B11DB4-E907-4F1F-8835-B9DAAB6E1F23' THEN '11B11DB4-E907-4F1F-8835-B9DAAB6E1F23'
            ELSE MAX(bd.公司GUID)
        END AS [公司GUID],
        CASE 
            WHEN @buguid = '11B11DB4-E907-4F1F-8835-B9DAAB6E1F23' THEN '总部'
            ELSE MAX(bd.公司名称)
        END AS [公司名称],
        GETDATE() AS [清洗日期],
        
        -- 分期数
        pc.已竣备完成_分期数 AS [已竣备分期_结算完成率等于100%_分期数],
        pc.已竣备95至100_分期数 AS [已竣备分期_结算完成率95%至100%_分期数],
        pc.已竣备小于95_分期数 AS [已竣备分期_结算完成率小于95%_分期数],
        pc.本年计划竣备_分期数 AS [本年计划竣备分期_分期数],
        pc.在建_分期数 AS [在建分期_分期数],
        pc.本年新开工_分期数 AS [本年新开工_分期数],
        pc.未开工_分期数 AS [未开工_分期数],
        pc.分期数合计 AS [分期数合计],

        -- 动态成本（单位：亿元）
        dc.已竣备完成_动态成本 / 100000000.0 AS [已竣备分期_结算完成率等于100%_动态成本],
        dc.已竣备95至100_动态成本 / 100000000.0 AS [已竣备分期_结算完成率95%至100%_动态成本],
        dc.已竣备小于95_动态成本 / 100000000.0 AS [已竣备分期_结算完成率小于95%_动态成本],
        dc.本年计划竣备_动态成本 / 100000000.0 AS [本年计划竣备分期_动态成本],
        dc.在建_动态成本 / 100000000.0 AS [在建分期_动态成本],
        dc.本年新开工_动态成本 / 100000000.0 AS [本年新开工_动态成本],
        dc.未开工_动态成本 / 100000000.0 AS [未开工_动态成本],
        dc.动态成本合计 / 100000000.0 AS [动态成本合计],

        -- 已签约未结算合约成本（单位：亿元）
        uc.已竣备完成_未结算 / 100000000.0 AS [已竣备分期_结算完成率等于100%_已签约未结算_合约成本],
        uc.已竣备95至100_未结算 / 100000000.0 AS [已竣备分期_结算完成率95%至100%_已签约未结算_合约成本],
        uc.已竣备小于95_未结算 / 100000000.0 AS [已竣备分期_结算完成率小于95%_已签约未结算_合约成本],
        uc.本年计划竣备_未结算 / 100000000.0 AS [本年计划竣备分期_已签约未结算_合约成本],
        uc.在建_未结算 / 100000000.0 AS [在建分期_已签约未结算_合约成本],
        uc.本年新开工_未结算 / 100000000.0 AS [本年新开工_已签约未结算_合约成本],
        uc.未开工_未结算 / 100000000.0 AS [未开工_已签约未结算_合约成本],
        uc.未结算合计 / 100000000.0 AS [已签约未结算_合约成本合计],

        -- 预留金（单位：亿元）
        rf.已竣备完成_预留金 / 100000000.0 AS [已竣备分期_结算完成率等于100%_预留金],
        rf.已竣备95至100_预留金 / 100000000.0 AS [已竣备分期_结算完成率95%至100%_预留金],
        rf.已竣备小于95_预留金 / 100000000.0 AS [已竣备分期_结算完成率小于95%_预留金],
        rf.本年计划竣备_预留金 / 100000000.0 AS [本年计划竣备分期_预留金],
        rf.在建_预留金 / 100000000.0 AS [在建分期_预留金],
        rf.本年新开工_预留金 / 100000000.0 AS [本年新开工_预留金],
        rf.未开工_预留金 / 100000000.0 AS [未开工_预留金],
        rf.预留金合计 / 100000000.0 AS [预留金合计],

        -- 占比计算
        CASE WHEN dc.动态成本合计 = 0 THEN 0 
             ELSE dc.已竣备完成_动态成本 * 100.0 / dc.动态成本合计 
        END AS [已竣备分期_结算完成率等于100%_占比],
        CASE WHEN dc.动态成本合计 = 0 THEN 0 
             ELSE dc.已竣备95至100_动态成本 * 100.0 / dc.动态成本合计 
        END AS [已竣备分期_结算完成率95%至100%_占比],
        CASE WHEN dc.动态成本合计 = 0 THEN 0 
             ELSE dc.已竣备小于95_动态成本 * 100.0 / dc.动态成本合计 
        END AS [已竣备分期_结算完成率小于95%_占比],
        CASE WHEN dc.动态成本合计 = 0 THEN 0 
             ELSE dc.本年计划竣备_动态成本 * 100.0 / dc.动态成本合计 
        END AS [本年计划竣备分期_占比],
        CASE WHEN dc.动态成本合计 = 0 THEN 0 
             ELSE dc.在建_动态成本 * 100.0 / dc.动态成本合计 
        END AS [在建分期_占比],
        CASE WHEN dc.动态成本合计 = 0 THEN 0 
             ELSE dc.本年新开工_动态成本 * 100.0 / dc.动态成本合计 
        END AS [本年新开工_占比],
        CASE WHEN dc.动态成本合计 = 0 THEN 0 
             ELSE dc.未开工_动态成本 * 100.0 / dc.动态成本合计 
        END AS [未开工_占比]

    FROM BaseData bd
    CROSS APPLY (
        SELECT 
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率等于100%' THEN 1 ELSE 0 END) AS 已竣备完成_分期数,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率95%至100%' THEN 1 ELSE 0 END) AS 已竣备95至100_分期数,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率小于95%' THEN 1 ELSE 0 END) AS 已竣备小于95_分期数,
            SUM(CASE WHEN 项目分期分类 = '本年计划竣备分期' THEN 1 ELSE 0 END) AS 本年计划竣备_分期数,
            SUM(CASE WHEN 项目分期分类 = '在建分期' THEN 1 ELSE 0 END) AS 在建_分期数,
            SUM(CASE WHEN 项目分期分类 = '本年新开工' THEN 1 ELSE 0 END) AS 本年新开工_分期数,
            SUM(CASE WHEN 项目分期分类 = '未开工' THEN 1 ELSE 0 END) AS 未开工_分期数,
            SUM(CASE WHEN 项目分期分类 IS NOT NULL THEN 1 ELSE 0 END) AS 分期数合计
    ) pc
    CROSS APPLY (
        SELECT 
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率等于100%' THEN 总成本情况_动态成本 ELSE 0 END) AS 已竣备完成_动态成本,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率95%至100%' THEN 总成本情况_动态成本 ELSE 0 END) AS 已竣备95至100_动态成本,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率小于95%' THEN 总成本情况_动态成本 ELSE 0 END) AS 已竣备小于95_动态成本,
            SUM(CASE WHEN 项目分期分类 = '本年计划竣备分期' THEN 总成本情况_动态成本 ELSE 0 END) AS 本年计划竣备_动态成本,
            SUM(CASE WHEN 项目分期分类 = '在建分期' THEN 总成本情况_动态成本 ELSE 0 END) AS 在建_动态成本,
            SUM(CASE WHEN 项目分期分类 = '本年新开工' THEN 总成本情况_动态成本 ELSE 0 END) AS 本年新开工_动态成本,
            SUM(CASE WHEN 项目分期分类 = '未开工' THEN 总成本情况_动态成本 ELSE 0 END) AS 未开工_动态成本,
            SUM(CASE WHEN 项目分期分类 IS NOT NULL THEN 总成本情况_动态成本 ELSE 0 END) AS 动态成本合计
    ) dc
    CROSS APPLY (
        SELECT 
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率等于100%' 
                THEN 总价合同_首次签约为总价包干_最新合约规划金额 + 
                     总价合同_首次签约为单价合同_目前已转总_最新合约规划金额 + 
                     单价合同_首次签约为单价合同且未完成转总_最新合约规划金额 
                ELSE 0 END) AS 已竣备完成_未结算,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率95%至100%' 
                THEN 总价合同_首次签约为总价包干_最新合约规划金额 + 
                     总价合同_首次签约为单价合同_目前已转总_最新合约规划金额 + 
                     单价合同_首次签约为单价合同且未完成转总_最新合约规划金额 
                ELSE 0 END) AS 已竣备95至100_未结算,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率小于95%' 
                THEN 总价合同_首次签约为总价包干_最新合约规划金额 + 
                     总价合同_首次签约为单价合同_目前已转总_最新合约规划金额 + 
                     单价合同_首次签约为单价合同且未完成转总_最新合约规划金额 
                ELSE 0 END) AS 已竣备小于95_未结算,
            SUM(CASE WHEN 项目分期分类 = '本年计划竣备分期' 
                THEN 总价合同_首次签约为总价包干_最新合约规划金额 + 
                     总价合同_首次签约为单价合同_目前已转总_最新合约规划金额 + 
                     单价合同_首次签约为单价合同且未完成转总_最新合约规划金额 
                ELSE 0 END) AS 本年计划竣备_未结算,
            SUM(CASE WHEN 项目分期分类 = '在建分期' 
                THEN 总价合同_首次签约为总价包干_最新合约规划金额 + 
                     总价合同_首次签约为单价合同_目前已转总_最新合约规划金额 + 
                     单价合同_首次签约为单价合同且未完成转总_最新合约规划金额 
                ELSE 0 END) AS 在建_未结算,
            SUM(CASE WHEN 项目分期分类 = '本年新开工' 
                THEN 总价合同_首次签约为总价包干_最新合约规划金额 + 
                     总价合同_首次签约为单价合同_目前已转总_最新合约规划金额 + 
                     单价合同_首次签约为单价合同且未完成转总_最新合约规划金额 
                ELSE 0 END) AS 本年新开工_未结算,
            SUM(CASE WHEN 项目分期分类 = '未开工' 
                THEN 合同签订情况_未结算的已签合同金额 
                ELSE 0 END) AS 未开工_未结算,
            SUM(CASE WHEN 项目分期分类 IS NOT NULL 
                THEN CASE WHEN 项目分期分类 = '未开工' 
                         THEN 合同签订情况_未结算的已签合同金额
                         ELSE 总价合同_首次签约为总价包干_最新合约规划金额 + 
                              总价合同_首次签约为单价合同_目前已转总_最新合约规划金额 + 
                              单价合同_首次签约为单价合同且未完成转总_最新合约规划金额 
                    END
                ELSE 0 END) AS 未结算合计
    ) uc
    CROSS APPLY (
        SELECT 
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率等于100%' 
                THEN 总价合同_首次签约为总价包干_预留金待发生 + 
                     总价合同_首次签约为单价合同_目前已转总_预留金待发生 + 
                     单价合同_首次签约为单价合同且未完成转总_预留金待发生 
                ELSE 0 END) AS 已竣备完成_预留金,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率95%至100%' 
                THEN 总价合同_首次签约为总价包干_预留金待发生 + 
                     总价合同_首次签约为单价合同_目前已转总_预留金待发生 + 
                     单价合同_首次签约为单价合同且未完成转总_预留金待发生 
                ELSE 0 END) AS 已竣备95至100_预留金,
            SUM(CASE WHEN 项目分期分类 = '已竣备分期_结算完成率小于95%' 
                THEN 总价合同_首次签约为总价包干_预留金待发生 + 
                     总价合同_首次签约为单价合同_目前已转总_预留金待发生 + 
                     单价合同_首次签约为单价合同且未完成转总_预留金待发生 
                ELSE 0 END) AS 已竣备小于95_预留金,
            SUM(CASE WHEN 项目分期分类 = '本年计划竣备分期' 
                THEN 总价合同_首次签约为总价包干_预留金待发生 + 
                     总价合同_首次签约为单价合同_目前已转总_预留金待发生 + 
                     单价合同_首次签约为单价合同且未完成转总_预留金待发生 
                ELSE 0 END) AS 本年计划竣备_预留金,
            SUM(CASE WHEN 项目分期分类 = '在建分期' 
                THEN 总价合同_首次签约为总价包干_预留金待发生 + 
                     总价合同_首次签约为单价合同_目前已转总_预留金待发生 + 
                     单价合同_首次签约为单价合同且未完成转总_预留金待发生 
                ELSE 0 END) AS 在建_预留金,
            SUM(CASE WHEN 项目分期分类 = '本年新开工' 
                THEN 总价合同_首次签约为总价包干_预留金待发生 + 
                     总价合同_首次签约为单价合同_目前已转总_预留金待发生 + 
                     单价合同_首次签约为单价合同且未完成转总_预留金待发生 
                ELSE 0 END) AS 本年新开工_预留金,
            0 AS 未开工_预留金,
            SUM(CASE WHEN 项目分期分类 IS NOT NULL AND 项目分期分类 <> '未开工'
                THEN 总价合同_首次签约为总价包干_预留金待发生 + 
                     总价合同_首次签约为单价合同_目前已转总_预留金待发生 + 
                     单价合同_首次签约为单价合同且未完成转总_预留金待发生 
                ELSE 0 END) AS 预留金合计
    ) rf
    GROUP BY bd.公司GUID, bd.公司名称;
END  