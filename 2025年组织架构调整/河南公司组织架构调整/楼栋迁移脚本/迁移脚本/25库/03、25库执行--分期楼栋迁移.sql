--=======25库执行

--========第一步：数据准备
--获取新旧分期对比表
CREATE TABLE #tmp_ProjectDZ(
	old_ProjGUID UNIQUEIDENTIFIER,  --项目GUID(迁移前)
	old_VersionGUID UNIQUEIDENTIFIER, --版本GUID（迁移前）
	old_ProjCode VARCHAR(100),      --项目CODE(迁移前)
	old_ProjName  VARCHAR(50),       --项目名称(迁移前)	
	old_BldGUID UNIQUEIDENTIFIER,   --工程楼栋GUID（迁移前）
	old_ProductBldGUID UNIQUEIDENTIFIER, --产品楼栋GUID（迁移前） 
	old_bldname VARCHAR(300),            --工程楼栋名称（迁移前）
	new_ProjGUID UNIQUEIDENTIFIER,  --项目GUID(迁移后)
	new_VersionGUID UNIQUEIDENTIFIER,  --版本GUID（迁移后）
	new_ProjCode VARCHAR(100),      --项目CODE(迁移后)
	new_ProjNamew VARCHAR(50)        --项目名称(迁移后)
) 

--因为一期是原分期不需要调整
--二期、三期是新建分期，需要进行迁移，要写入到表中
--新版本采用新添加的定位版的分期版本
--原版本采用最新的已审核的版本数据（部分楼栋在预售查丈，部分在建规证）
INSERT INTO #tmp_ProjectDZ(old_ProjGUID,old_VersionGUID , old_ProjName, old_BldGUID, old_ProductBldGUID, old_bldname,new_ProjGUID, new_VersionGUID, new_ProjNamew)
VALUES
-- 三期数据 (new_ProjCode = '371034.003')
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', 'ED6D5D2E-A36B-4D97-A497-BE944BE5BC06', '8CDAA00E-C8C8-4EE6-8D4B-CC4E985D43FA', '杓袁7号地-22号楼','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', '994E86F5-43D4-4C2C-92D0-2CA37194AD5B', '81175FFD-632B-4A96-80BD-E2A7856CF80F', '杓袁7号地-23号楼','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', '27BF90E7-5A9D-4C45-ADA7-4D07F25BD296', '662B0CF8-73C6-432F-8AD5-2DAB399C813C', '杓袁7号地-24号楼','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', '85E3CD64-7904-4680-9AE4-1108D507B48C', '7CB0007F-C81F-4CC3-9E78-F5D010A60538', '杓袁7号地-25号楼','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', '2866A4B9-B899-42DB-B4FB-3168B4201549', 'A5E1B144-F2FC-4325-9D66-E1A4A51BA062', '杓袁7号地-26号楼','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', 'EC2936F8-DEBC-4C78-9F21-5B6DB70991AF', 'D9F15062-2692-483F-822D-27B743B2E81C', '杓袁7号地-27号楼','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', '1982B203-7204-47A0-A58F-6DB1AB8B8E91', '4DB62A06-9138-411A-B4E9-495F432B6565', '杓袁7号地-28号楼','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', 'D4FD24BE-B6BB-4951-B5BF-B082B93F53A6', 'F4F82FC7-0878-460B-B0B2-50D0696C18D2', '杓袁7号地-29号楼','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', '326F04C9-D3A2-4474-A3AF-269FEDA1E2B3', '7220C4FD-FF79-47B6-8783-4E61FBAB10AB', '杓袁7号地-30号楼','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', '7FBF2327-48FD-425C-A52A-D52DED30112E', '7CBFF3D8-CB43-4D2F-94C5-84C4247588B0', '杓袁7号地-31号楼','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', '8EBC1384-221A-4E82-9C31-C81899C2B6E1', '7449FAB2-B0A0-434A-AB8B-9F6B1E879A46', '杓袁7号地-32号楼','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', '7E6895F0-3BC8-45A7-9364-0A7DD352BB18', '3F40E986-9D61-4E38-874C-F241E8D9E64A', '杓袁7号地-33号楼','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', '73AAD447-5712-47CB-96B1-BCA266F61D1B', 'B1137C35-B41B-4E7C-966E-3EE9F2327DD1', '杓袁7号地-34号楼','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', '709EB878-E201-49B6-8263-5E0AD6FFBD4E', '547651C2-0BDB-433D-98D6-8BCB1712C16C', '杓袁7号地-普通地下车库-三期','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', '9336307D-94A6-4B58-8FC0-A0AF24C8DC7D', 'E952D962-E47F-4280-B501-2A6ADE8855A2', '杓袁7号地-商业-三期','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', 'E1F3ED80-286D-447C-B71D-038E4FEFB770', 'F11CC7C4-3283-463E-AB88-BC8F47D80057', '杓袁7号地-其它公建配套-三期','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', 'AE28C9EF-3BDE-4E5C-A7BF-6B304A7B4887', 'B21B717F-CC08-455D-895A-78F327D8A9BC', '杓袁7号地-普通地下车库-车位（非)-三期','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969', '杓袁7号地', '8C17CC6D-CAB9-4830-AA94-04E213B4C4F8', 'B774E077-D76F-46A2-9296-57D910B8AFDC', '杓袁7号地-便民店-三期','7E9A29A0-2E74-4686-82D7-1F2E15262222','7E9A29A0-2E74-4686-82D7-1F2E15262222', ''),

-- 二期数据 (new_ProjCode = '371034.002')
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', '13060C89-17F9-4F3F-A82C-2112C8355B64', 'BE4F5E1A-8EB3-4DAA-832B-92314C7A2B86', '杓袁7号地-35号楼', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', 'AD37B292-9FBF-4C29-9831-B205D5D6AA64', 'A73F7346-5C55-4FCC-A250-6CBD922269F7', '杓袁7号地-36号楼', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', '8BABD9AC-1A07-4A75-99DA-F5FF6D9523C3', 'ED50DDFE-E29F-4DB2-8BEE-C9834A026883', '杓袁7号地-37号楼', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', '7ADE2608-8904-412F-B77F-E84762AF0CAE', '26F590B7-BAC0-4BEC-8921-31B242C9A748', '杓袁7号地-38号楼', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', '07E87EE9-5E33-477C-8B9D-F51DC62AB0B2', 'A2F648DF-40B1-4FC9-842E-804DDF4EDB7A', '杓袁7号地-39号楼', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', 'B9A01628-627A-4B43-AFB1-642A545D635B', '49A474BE-33CC-4EDF-A926-D52A8E2C0BD4', '杓袁7号地-40号楼', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', '0D16FB7C-62C2-4B20-8281-716CDD6B9A05', '97E8676E-0271-495E-AFC7-99C287D17CFE', '杓袁7号地-41号楼', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', '6974F9C0-94A5-43A3-BC85-BB4B0501557F', 'AB3E8108-FB4F-4D87-B145-D05B97C3EB25', '杓袁7号地-42号楼', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', '940A92E4-D428-4B80-BB00-52803EBBA4D0', '3A480023-2065-4524-9FB0-68BD6B68C38A', '杓袁7号地-普通地下车库-二期', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', '85D35CEE-4ACB-4E30-9E5F-E259C3F839EF', '84574C14-9165-49D3-8222-AAEBC69E2614', '杓袁7号地-人防车库-二期', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',   ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', '0E581B53-05F9-4E4B-9B3E-87F93990291E', '2291EE97-B0BD-4C1F-8E3F-EA1BD4301EB3', '杓袁7号地-便民店-二期37S5', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',   ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', '74870DB6-81AE-4FB3-9D21-98064578E00A', '277F8CAC-CDAA-4623-ADE8-A4AB2BFA4E84', '杓袁7号地-43号楼', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',   ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', '61BE2294-70E2-4CC3-BCDF-0164DF659FF9', '0BADF4BC-B31E-415F-A578-220129FB47C7', '杓袁7号地-商业-二期', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', '6EA516C2-2769-4355-8E8B-AD11777A4669', '2C8F4349-EB91-496F-847C-74270381378F', '杓袁7号地-普通地下车库-车位（非)-二期', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', 'A6BC9573-842D-420C-A2FD-0A60661A1304', 'C15C693A-978C-44E6-B829-2D0F8252B829', '杓袁7号地-其它公建配套-二期3741', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', 'BE1B5073-C9C9-4FEB-8E4E-780F5F86CB8E', '99323C8A-BB52-43E8-90A3-B02394077B58', '杓袁7号地-其它公建配套-二期3', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', '4F5A31C7-8306-46EC-B253-62E58A40D9A8', '6F79C36A-FEB2-4A7B-8650-3E13908C980B', '杓袁7号地-其它公建配套-二期35', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', '75676DCE-1A80-45D8-9C9E-354EABDE517D', 'C2D4355B-C760-4CC0-B670-E2110661A14B', '杓袁7号地-便民店-二期2', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  ''),
('0E63E1AD-4703-4A95-B661-9E8E415E041F','33D55E17-879A-F011-B3A7-F40270D39969',  '杓袁7号地', 'B9AAEA73-F93B-4DA5-9D22-4DBE31DDD809', '72D9BBC6-75B7-4896-831C-64FC5E2BCBBD', '杓袁7号地-地下设备用房-二期2', '75FF507F-46A0-4288-951B-4A02A48C7AD4','75FF507F-46A0-4288-951B-4A02A48C7AD4',  '');


---====测试用的对照数据
--INSERT INTO #tmp_ProjectDZ(old_ProjGUID, old_VersionGUID, old_ProjName, old_BldGUID, old_ProductBldGUID, old_bldname,new_ProjGUID,new_VersionGUID,  new_ProjNamew)
--VALUES
---- 三期数据 (new_ProjCode = '371034.003')
--('5f4a536b-d813-e911-80bf-e61f13c57837','C4F43217-C585-ED11-B3A2-F40270D39969', '杓袁7号地', '4B2B4291-8D30-4653-95BE-03A3E3D9F019', '314D8A0E-C120-428F-993C-2799F22B5857', '杓袁7号地-22号楼','2df7f1ee-8e5b-ea11-80b8-0a94ef7517dd','A77F62E3-9EDB-EB11-B398-F40270D39969', ''),
--('5f4a536b-d813-e911-80bf-e61f13c57837','C4F43217-C585-ED11-B3A2-F40270D39969', '杓袁7号地', 'BF700612-80DA-4A20-B56C-25D2D5E6D9EA', '91221979-AF52-4AAC-A546-CDC01E474B32', '杓袁7号地-23号楼','2df7f1ee-8e5b-ea11-80b8-0a94ef7517dd','A77F62E3-9EDB-EB11-B398-F40270D39969', '')




--======第二步：备份数据
----备份表
SELECT * INTO mdm_GCBuild_bak20251030 FROM dbo.mdm_GCBuild; 
SELECT * INTO p_Building_bak20251030 FROM p_Building;
SELECT * INTO k_ProviderProjectConstru_bak20251030 FROM k_ProviderProjectConstru;


--========第三步：处理数据
--===投管系统
--刷新楼栋
UPDATE a SET a.ProjGUID=B.new_ProjGUID
FROM mdm_GCBuild a 
INNER JOIN #tmp_ProjectDZ b ON a.GCBldGUID=b.old_BldGUID;

--===销售系统
UPDATE pb
SET	pb.ParentCode=p.ProjCode,
pb.BldFullName=p.ProjName + '-' + pb.BldName,
pb.ProjGUID = p.ProjGUID
FROM dbo.p_Building pb 
INNER JOIN #tmp_ProjectDZ dz ON pb.BldGUID=dz.old_ProductBldGUID
INNER JOIN dbo.p_Project p ON p.ProjGUID=dz.new_ProjGUID;

--===客服
UPDATE a
SET	a.ProjGUID=p.ProjGUID
FROM k_ProviderProjectConstru a
INNER JOIN #tmp_ProjectDZ dz ON a.BldGUID=dz.old_ProductBldGUID
INNER JOIN dbo.p_Project p ON p.ProjGUID=dz.new_ProjGUID;


 DROP TABLE #tmp_ProjectDZ;