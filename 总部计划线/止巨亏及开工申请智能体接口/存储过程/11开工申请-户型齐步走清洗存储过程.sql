
CREATE OR ALTER PROC [dbo].[usp_s_集团开工申请户型智能体数据提取]
AS
BEGIN

  -- 取户型齐步走报表
  create TABLE #huxing (   
    BUGUID UNIQUEIDENTIFIER,
    projguid UNIQUEIDENTIFIER,
    平台公司 varchar(200),
    城市 varchar(200),
    城市分类 varchar(200),
    标签城市分类 varchar(200),
    城市六分化 varchar(200),
    项目五分类 varchar(200),
    板块分类 varchar(200),
    板块能级 varchar(200),
    并表方式 varchar(200),
    项目股权比例 DECIMAL(38,10),
    项目出资比例 DECIMAL(38,10),
    财务收益比例 DECIMAL(38,10),
    操盘方式 VARCHAR(200),
    获取时间 DATETIME,
    项目名 VARCHAR(200),
    推广名 VARCHAR(200),
    项目代码 VARCHAR(200),
    投管代码 VARCHAR(200),
    操盘方式2 VARCHAR(200),
    并表方式2 VARCHAR(200),
    总可售面积合计 DECIMAL(38,10),
    总可售面积其中住宅 DECIMAL(38,10),
    总可售面积其中商业 DECIMAL(38,10),
    总可售面积其中写字楼 DECIMAL(38,10),
    总可售面积其中公寓 DECIMAL(38,10),
    总可售面积其中车位 DECIMAL(38,10),
    总可售套数合计 DECIMAL(38,10),
    总可售套数其中住宅 DECIMAL(38,10),
    总可售套数其中商业 DECIMAL(38,10),
    总可售套数其中写字楼 DECIMAL(38,10),
    总可售套数其中公寓 DECIMAL(38,10),
    总可售套数其中车位 DECIMAL(38,10),
    车位首套成交日期 DATETIME,
    住宅首套成交日期 DATETIME,
    户型总可售住宅住宅套数 DECIMAL(38,10),
    户型总可售住宅住宅80以下 DECIMAL(38,10),
    户型总可售住宅住宅8090平 DECIMAL(38,10),
    户型总可售住宅住宅90100平 DECIMAL(38,10),
    户型总可售住宅住宅100110平 DECIMAL(38,10),
    户型总可售住宅住宅110120平 DECIMAL(38,10),
    户型总可售住宅住宅120130平 DECIMAL(38,10),
    户型总可售住宅住宅130140平 DECIMAL(38,10),
    户型总可售住宅住宅140150平 DECIMAL(38,10),
    户型总可售住宅住宅150160平 DECIMAL(38,10),
    户型总可售住宅住宅160170平 DECIMAL(38,10),
    户型总可售住宅住宅170180平 DECIMAL(38,10),
    户型总可售住宅住宅180平以上 DECIMAL(38,10),
    户型总可售住宅住宅90以下 DECIMAL(38,10),
    户型总可售住宅住宅90140平 DECIMAL(38,10),
    户型总可售住宅住宅140180平 DECIMAL(38,10),
    户型总可售住宅住宅180220平 DECIMAL(38,10),
    户型总可售住宅住宅220260平 DECIMAL(38,10),
    户型总可售住宅住宅260平以上 DECIMAL(38,10),
    户型已推住宅套数 DECIMAL(38,10),
    户型已推住宅80以下 DECIMAL(38,10),
    户型已推住宅8090平 DECIMAL(38,10),
    户型已推住宅90100平 DECIMAL(38,10),
    户型已推住宅100110平 DECIMAL(38,10),
    户型已推住宅110120平 DECIMAL(38,10),
    户型已推住宅120130平 DECIMAL(38,10),
    户型已推住宅130140平 DECIMAL(38,10),
    户型已推住宅140150平 DECIMAL(38,10),
    户型已推住宅150160平 DECIMAL(38,10),
    户型已推住宅160170平 DECIMAL(38,10),
    户型已推住宅170180平 DECIMAL(38,10),
    户型已推住宅180平以上 DECIMAL(38,10),
    户型已推住宅住宅90以下 DECIMAL(38,10),
    户型已推住宅住宅90140平 DECIMAL(38,10),
    户型已推住宅住宅140180平 DECIMAL(38,10),
    户型已推住宅住宅180220平 DECIMAL(38,10),
    户型已推住宅住宅220260平 DECIMAL(38,10),
    户型已推住宅住宅260平以上 DECIMAL(38,10),
    户型已售住宅 DECIMAL(38,10),
    户型已售住宅住宅90以下 DECIMAL(38,10),
    户型已售住宅住宅90140平 DECIMAL(38,10),
    户型已售住宅住宅140180平 DECIMAL(38,10),
    户型已售住宅住宅180220平 DECIMAL(38,10),
    户型已售住宅住宅220260平 DECIMAL(38,10),
    户型已售住宅住宅260平以上 DECIMAL(38,10),
    户型去化率住宅住宅90以下 DECIMAL(38,10),
    户型去化率住宅住宅90140平 DECIMAL(38,10),
    户型去化率住宅住宅140180平 DECIMAL(38,10),
    户型去化率住宅住宅180220平 DECIMAL(38,10),
    户型去化率住宅住宅220260平 DECIMAL(38,10),
    户型去化率住宅住宅260平以上 DECIMAL(38,10),
    最大去化率 DECIMAL(38,10),
    最小去化率 DECIMAL(38,10),
    户型去化率极差 DECIMAL(38,10),
    户型范围内已售住宅 DECIMAL(38,10),
    户型范围内已售住宅住宅90以下 DECIMAL(38,10),
    户型范围内已售住宅住宅90140平 DECIMAL(38,10),
    户型范围内已售住宅住宅140180平 DECIMAL(38,10),
    户型范围内已售住宅住宅180220平 DECIMAL(38,10),
    户型范围内已售住宅住宅220260平 DECIMAL(38,10),
    户型范围内已售住宅住宅260平以上 DECIMAL(38,10),
    是否纳入考核 VARCHAR(200),
    qxdate DATETIME
  )
  
   declare @buguidList  varchar(max)=null -- 公司GUID列表
   declare @Thisyear_start DATETIME = DATEADD(yy, DATEDIFF(yy, 0, GETDATE()), 0);  
   declare @Thisyear_end   DATETIME = DATEADD(ms, -3, DATEADD(yy, DATEDIFF(yy, 0, GETDATE()) + 1, 0));  

   select @buguidList = STUFF(
        (
            SELECT distinct RTRIM(',' + CONVERT(VARCHAR(MAX), unit.buguid))
            FROM [172.16.4.141].erp25.dbo.myBusinessUnit unit
            INNER JOIN [172.16.4.141].erp25.dbo.p_project p ON unit.buguid = p.buguid
            WHERE IsEndCompany = 1 AND IsCompany = 1
            FOR XML PATH('')
        ), 1, 1, '' );
   insert into #huxing
   exec [172.16.4.141].erp25.dbo.usp_s_户型齐步走 @buguidList, @Thisyear_start,@Thisyear_end



 /***********************************************************************
    步骤3：删除当天已存在的数据，避免重复插入
    说明：
        - 以清洗日期为准，删除当天数据
        - 保证数据唯一性
    ***********************************************************************/
    DELETE FROM s_集团开工申请户型明细表智能体数据提取
    WHERE DATEDIFF(DAY, 清洗日期, GETDATE()) = 0

    insert into s_集团开工申请户型明细表智能体数据提取 (
      [projguid]
      ,[平台公司]
      ,[项目名]
      ,[推广名]
      ,[项目代码]
      ,[投管代码]
      ,[总可售住宅套数_户型总可售住宅住宅套数]
      ,[总可售住宅套数_户型总可售住宅住宅90以下]
      ,[总可售住宅套数_户型总可售住宅住宅90140平]
      ,[总可售住宅套数_户型总可售住宅住宅140180平]
      ,[总可售住宅套数_户型总可售住宅住宅180220平]
      ,[总可售住宅套数_户型总可售住宅住宅220260平]
      ,[总可售住宅套数_户型总可售住宅住宅260平以上]
      ,[已推住宅套数_户型已推住宅套数]
      ,[已推住宅套数_户型已推住宅住宅90以下]
      ,[已推住宅套数_户型已推住宅住宅90140平]
      ,[已推住宅套数_户型已推住宅住宅140180平]
      ,[已推住宅套数_户型已推住宅住宅180220平]
      ,[已推住宅套数_户型已推住宅住宅220260平]
      ,[已推住宅套数_户型已推住宅住宅260平以上]
      ,[已售住宅套数_户型已售住宅]
      ,[已售住宅套数_户型已售住宅住宅90以下]
      ,[已售住宅套数_户型已售住宅住宅90140平]
      ,[已售住宅套数_户型已售住宅住宅140180平]
      ,[已售住宅套数_户型已售住宅住宅180220平]
      ,[已售住宅套数_户型已售住宅住宅220260平]
      ,[已售住宅套数_户型已售住宅住宅260平以上]
      ,[去化率_户型去化率住宅住宅90以下]
      ,[去化率_户型去化率住宅住宅90140平]
      ,[去化率_户型去化率住宅住宅140180平]
      ,[去化率_户型去化率住宅住宅180220平]
      ,[去化率_户型去化率住宅住宅220260平]
      ,[去化率_户型去化率住宅住宅260平以上]
      ,[极差_最大去化率]
      ,[极差_最小去化率]
      ,[极差_户型去化率极差]
      ,[本年已售套数_范围内已售住宅]
      ,[本年已售套数_已售住宅90以下]
      ,[本年已售套数_已售住宅90140平]
      ,[本年已售套数_已售住宅140180平]
      ,[本年已售套数_已售住宅180220平]
      ,[本年已售套数_已售住宅220260平]
      ,[本年已售套数_已售住宅260平以上]
      ,[是否纳入考核]
      ,[清洗日期]
    )
   select 
       hx.[projguid]
      ,hx.[平台公司]
      ,hx.[项目名]
      ,hx.[推广名]
      ,hx.[项目代码]
      ,hx.[投管代码]

      ,hx.户型总可售住宅住宅套数  as  [总可售住宅套数_户型总可售住宅住宅套数]
      ,hx.户型总可售住宅住宅90以下  as  [总可售住宅套数_户型总可售住宅住宅90以下]
      ,hx.户型总可售住宅住宅90140平  as  [总可售住宅套数_户型总可售住宅住宅90140平]
      ,hx.户型总可售住宅住宅140180平  as  [总可售住宅套数_户型总可售住宅住宅140180平]
      ,hx.户型总可售住宅住宅180220平  as  [总可售住宅套数_户型总可售住宅住宅180220平]
      ,hx.户型总可售住宅住宅220260平  as  [总可售住宅套数_户型总可售住宅住宅220260平]
      ,hx.户型总可售住宅住宅260平以上  as  [总可售住宅套数_户型总可售住宅住宅260平以上]

      ,hx.户型已推住宅套数  as  [已推住宅套数_户型已推住宅套数]
      ,hx.户型已推住宅住宅90以下  as  [已推住宅套数_户型已推住宅住宅90以下]
      ,hx.户型已推住宅住宅90140平  as  [已推住宅套数_户型已推住宅住宅90140平]
      ,hx.户型已推住宅住宅140180平  as  [已推住宅套数_户型已推住宅住宅140180平]
      ,hx.户型已推住宅住宅180220平  as  [已推住宅套数_户型已推住宅住宅180220平]
      ,hx.户型已推住宅住宅220260平  as  [已推住宅套数_户型已推住宅住宅220260平]
      ,hx.户型已推住宅住宅260平以上  as  [已推住宅套数_户型已推住宅住宅260平以上]

      ,hx.户型已售住宅  as  [已售住宅套数_户型已售住宅]
      ,hx.户型已售住宅住宅90以下  as  [已售住宅套数_户型已售住宅住宅90以下]
      ,hx.户型已售住宅住宅90140平  as  [已售住宅套数_户型已售住宅住宅90140平]
      ,hx.户型已售住宅住宅140180平  as  [已售住宅套数_户型已售住宅住宅140180平]
      ,hx.户型已售住宅住宅180220平  as  [已售住宅套数_户型已售住宅住宅180220平]
      ,hx.户型已售住宅住宅220260平  as  [已售住宅套数_户型已售住宅住宅220260平]
      ,hx.户型已售住宅住宅260平以上  as  [已售住宅套数_户型已售住宅住宅260平以上]
      
      ,hx.户型去化率住宅住宅90以下 * 100.0 as  [去化率_户型去化率住宅住宅90以下]
      ,hx.户型去化率住宅住宅90140平 * 100.0 as  [去化率_户型去化率住宅住宅90140平]
      ,hx.户型去化率住宅住宅140180平 * 100.0 as  [去化率_户型去化率住宅住宅140180平]
      ,hx.户型去化率住宅住宅180220平 * 100.0 as  [去化率_户型去化率住宅住宅180220平]
      ,hx.户型去化率住宅住宅220260平 * 100.0 as  [去化率_户型去化率住宅住宅220260平]
      ,hx.户型去化率住宅住宅260平以上 * 100.0 as  [去化率_户型去化率住宅住宅260平以上]
      
      ,hx.最大去化率 * 100 as  [极差_最大去化率]
      ,hx.最小去化率 * 100.0 as  [极差_最小去化率]
      ,hx.户型去化率极差 * 100.0 as  [极差_户型去化率极差]
      
      ,hx.户型范围内已售住宅  as  [本年已售套数_范围内已售住宅]
      ,hx.户型范围内已售住宅住宅90以下  as  [本年已售套数_已售住宅90以下]
      ,hx.户型范围内已售住宅住宅90140平  as  [本年已售套数_已售住宅90140平]
      ,hx.户型范围内已售住宅住宅140180平  as  [本年已售套数_已售住宅140180平]
      ,hx.户型范围内已售住宅住宅180220平  as  [本年已售套数_已售住宅180220平]
      ,hx.户型范围内已售住宅住宅220260平  as  [本年已售套数_已售住宅220260平]
      ,hx.户型范围内已售住宅住宅260平以上  as  [本年已售套数_已售住宅260平以上]
      
      ,hx.是否纳入考核  as  [是否纳入考核]
      ,hx.qxdate [清洗日期]
   from #huxing hx


 /***********************************************************************
    步骤5：清理历史数据，仅保留必要快照
    说明：
        1. 保留当天数据
        2. 仅保留以下特殊快照，其余超过7天的历史数据将被删除：
            - 每周一
            - 每月1号
            - 每月最后一天
            - 每年最后一天
    ***********************************************************************/
    DELETE FROM s_集团开工申请户型明细表智能体数据提取
    WHERE
        (
            -- 非每周一
            DATENAME(WEEKDAY, 清洗日期) <> '星期一'
            -- 非每月1号
            AND DATEPART(DAY, 清洗日期) <> 1
            -- 非每年最后一天
            AND DATEDIFF(DAY, 清洗日期, CONVERT(VARCHAR(4), YEAR(清洗日期)) + '-12-31') <> 0
            -- 非每月最后一天
            AND DATEDIFF(DAY, 清洗日期, DATEADD(ms, -3, DATEADD(mm, DATEDIFF(m, 0, 清洗日期) + 1, 0))) <> 0
            -- 距今超过7天
            AND DATEDIFF(DAY, 清洗日期, GETDATE()) > 7
        )

    /***********************************************************************
    步骤6：查询当天数据，供后续分析或校验
    ***********************************************************************/
    SELECT *
    FROM s_集团开工申请户型明细表智能体数据提取
    WHERE DATEDIFF(DAY, 清洗日期, GETDATE()) = 0
    ORDER BY 项目名

   -- 删除临时表
   drop table #huxing

end 
