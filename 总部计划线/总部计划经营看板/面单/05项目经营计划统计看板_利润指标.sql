-- 利润指标统计存储过程
CREATE OR ALTER PROC usp_zb_jyjhtjkb_Profit
AS
BEGIN
    /**************************************************************
    * 1. 生成F076临时表，获取最新一版F076项目运营情况数据
    *    包含：项目GUID、项目获取时间、立项/动态税前税后利润、固定资产等
    ***************************************************************/
    SELECT 
        f076.项目GUID,                                   -- 项目GUID
        p.BeginDate AS 项目获取时间,                     -- 项目获取时间
        f076.立项税前利润,                               -- 立项税前利润
        f076.税前利润计划口径,                           -- 动态税前利润
        f076.立项税后利润,                               -- 立项税后利润
        f076.税后利润计划口径,                           -- 动态税后利润
        f076.固定资产计划口径,                           -- 动态固定资产
        f076.立项固定资产                                -- 立项固定资产
    INTO #F076
    FROM data_wide_dws_qt_nmap_s_F076项目运营情况跟进表 f076
    INNER JOIN data_wide_dws_mdm_Project p 
        ON f076.项目GUID = p.projguid AND p.level = 2
    WHERE versionguid IN (
        SELECT TOP 1 versionguid
        FROM data_wide_dws_qt_nmap_s_F076项目运营情况跟进表
        ORDER BY EndTime DESC
    );

    /**************************************************************
    * 2. 生成F056临时表，统计每个父项目（即二级项目）的动态总货值
    *    动态总货值单位：万元
    ***************************************************************/
    SELECT  
        p.ParentGUID AS projguid,                         -- 项目GUID（父项目）
        SUM(ISNULL(动态总货值, 0)) / 10000.0 AS 动态总货值  -- 动态总货值（万元）
    INTO #F056
    FROM data_wide_dws_qt_F05601 F056
    INNER JOIN data_wide_dws_mdm_Project p 
        ON F056.projguid = p.projguid 
    GROUP BY p.ParentGUID

    /**************************************************************
    * 3. 生成立项版总货值临时表
    *    立项定位版不分业态经营利润汇总宽表，单位：亿元
    ***************************************************************/
    SELECT  
        t.projguid,                                       -- 项目GUID
        t.totalsaleamount / 100000000.0 AS 总货值_立项版,   -- 总货值_立项版（亿元）
        t.PreTaxCostProfitRate 税前成本利润率_立项版
    INTO #lx
    FROM data_wide_dws_ys_SumOperatingProfitDataLXDWBfYt t
    WHERE EditonType = '立项版'

    -- 取M002
    SELECT 
        projguid,
        -- SUM(当期签约金额不含税,0) AS 当期签约金额不含税,
        SUM(isnull(净利润签约, 0)) /10000.0 AS [已实现税后利润-动态版],
        CASE 
            WHEN SUM(isnull(当期签约金额不含税, 0)) = 0 THEN 0
            ELSE SUM(净利润签约) / SUM(isnull(当期签约金额不含税, 0))
        END AS [已实现销售净利率-动态版]   -- M002项目累计已签约净利率
    INTO #M002
    FROM data_wide_dws_qt_M002项目业态级毛利净利表
    WHERE versionType IN ('累计版')
	group by projguid

    /**************************************************************
    * 4. 删除当天已存在的数据，避免重复插入
    ***************************************************************/
    DELETE FROM zb_jyjhtjkb_Profit
    WHERE DATEDIFF(DAY, 清洗日期, GETDATE()) = 0;

    /**************************************************************
    * 5. 汇总各项数据，插入利润指标表
    *    说明：将各临时表数据汇总，插入到目标表zb_jyjhtjkb_Profit
    ***************************************************************/
    INSERT INTO zb_jyjhtjkb_Profit (
        [buguid],                        -- 事业部GUID
        [projguid],                      -- 项目GUID
        [清洗日期],                      -- 当前清洗日期
        [税前成本利润率_动态版],           -- 动态版税前成本利润率
        [税前成本利润率_立项版],           -- 立项版税前成本利润率
        [税前利润_动态版],                 -- 动态版税前利润
        [税前利润_立项版],                 -- 立项版税前利润
        [销售净利率_动态版],               -- 动态版销售净利率
        [销售净利率_立项版],               -- 立项版销售净利率
        [税后利润_动态版],                 -- 动态版税后利润
        [税后利润_立项版],                 -- 立项版税后利润
        [留存资产_动态版],                 -- 动态版留存资产
        [留存资产_立项版],                 -- 立项版留存资产
        [税后现金利润_动态版],             -- 动态版税后现金利润
        [税后现金利润_立项版],             -- 立项版税后现金利润
        [已实现税后利润_动态版],           -- 动态版已实现税后利润
        [已实现销售净利率_动态版],         -- 动态版已实现销售净利率
        [未实现税后利润_动态版]            -- 动态版未实现税后利润
    )
    SELECT
        p.buguid AS [buguid],                                -- 事业部GUID
        p.projguid AS [projguid],                            -- 项目GUID
        GETDATE() AS [清洗日期],                             -- 当前清洗日期
        ylgh.税前成本利润率_账面口径 AS [税前成本利润率_动态版],                      -- 
        lx.税前成本利润率_立项版 AS [税前成本利润率_立项版],                      -- 
        f076.税前利润计划口径 AS [税前利润_动态版],           -- 动态版税前利润
        f076.立项税前利润 AS [税前利润_立项版],               -- 立项版税前利润
        -- 动态版销售净利率 = 税后利润计划口径 / (动态总货值 / 1.09)
        CASE 
            WHEN ISNULL(F056.动态总货值, 0) = 0 THEN 0
            ELSE ISNULL(F076.税后利润计划口径, 0) / ISNULL(F056.动态总货值, 0) / 1.09
        END AS [销售净利率_动态版],
        -- 立项版销售净利率 = 立项税后利润 / (总货值_立项版 / 1.09)
        CASE 
            WHEN ISNULL(lx.总货值_立项版, 0) = 0 THEN 0
            ELSE ISNULL(F076.立项税后利润, 0) / ISNULL(lx.总货值_立项版, 0) / 1.09
        END AS [销售净利率_立项版],
        F076.税后利润计划口径 AS [税后利润_动态版],            -- 动态版税后利润
        F076.立项税后利润 AS [税后利润_立项版],                -- 立项版税后利润
        F076.固定资产计划口径 AS [留存资产_动态版],            -- 动态版留存资产
        F076.立项固定资产 AS [留存资产_立项版],                -- 立项版留存资产
        isnull(F076.税后利润计划口径,0) - isnull(F076.固定资产计划口径,0) AS [税后现金利润_动态版],                         -- 【税后利润-动态版】-【留存资产-动态版】
        isnull(F076.立项税后利润,0) - isnull(F076.立项固定资产,0) AS [税后现金利润_立项版],                         --  【税后利润-立项版】-【留存资产-立项版】
        m002.[已实现税后利润-动态版] AS [已实现税后利润_动态版],                       -- 暂无数据，置空
        m002.[已实现销售净利率-动态版] AS [已实现销售净利率_动态版],                     -- 暂无数据，置空
        isnull(F076.税后利润计划口径,0) - isnull(m002.[已实现销售净利率-动态版],0) AS [未实现税后利润_动态版]                        -- 【税后利润-动态版】-【已实现税后利润-动态版】
    FROM data_wide_dws_mdm_Project p
    left  join  dw_f_TopProJect_ProfitCost_ylgh ylgh on p.projguid = ylgh.项目guid
    LEFT JOIN #F076 f076 ON f076.项目GUID = p.projguid
    LEFT JOIN #lx lx ON lx.projguid = p.projguid
    LEFT JOIN #F056 f056 ON f056.projguid = p.projguid
    left join #M002  m002 on m002.projguid =p.projguid
    WHERE p.level = 2; -- 只统计二级项目

    /**************************************************************
    * 6. 查询当天插入的最终数据，便于校验
    ***************************************************************/
    SELECT
        [buguid], [projguid], [清洗日期],
        [税前成本利润率_动态版], [税前成本利润率_立项版],
        [税前利润_动态版], [税前利润_立项版],
        [销售净利率_动态版], [销售净利率_立项版],
        [税后利润_动态版], [税后利润_立项版],
        [留存资产_动态版], [留存资产_立项版],
        [税后现金利润_动态版], [税后现金利润_立项版],
        [已实现税后利润_动态版], [已实现销售净利率_动态版],
        [未实现税后利润_动态版]
    FROM zb_jyjhtjkb_Profit
    WHERE DATEDIFF(DAY, 清洗日期, GETDATE()) = 0;

    /**************************************************************
    * 7. 删除临时表，释放资源
    ***************************************************************/
    DROP TABLE #F076;
    DROP TABLE #lx;
    DROP TABLE #F056;

END

-- -- 以下为历史查询SQL示例，可用于按指定日期查询利润指标
-- SELECT
--     [buguid],
--     [projguid],
--     [清洗日期],
--     isnull(lczy.[税前成本利润率-动态版], pf.[税前成本利润率_动态版] ) as [税前成本利润率_动态版],
--     [税前成本利润率_立项版],
--     CASE 
--         WHEN [税前成本利润率_动态版] IS NOT NULL AND [税前成本利润率_立项版] IS NOT NULL
--         THEN ISNULL([税前成本利润率_立项版], 0) - isnull(lczy.[税前成本利润率-动态版], pf.[税前成本利润率_动态版] ) 
--     END AS [税前成本利润率偏差], 

--     isnull(lczy.[税前利润-动态版], pf.[税前利润_动态版] ) as [税前利润_动态版],
--     [税前利润_立项版],
--     CASE 
--         WHEN [税前利润_动态版] IS NOT NULL AND [税前利润_立项版] IS NOT NULL
--         THEN ISNULL([税前利润_立项版], 0) - isnull(lczy.[税前利润-动态版], pf.[税前利润_动态版] ) 
--     END AS [税前利润偏差],

--     isnull(lczy.[销售净利率-动态版],  pf.[销售净利率_动态版] ) as [销售净利率_动态版],
--     [销售净利率_立项版],
--     CASE 
--         WHEN [销售净利率_动态版] IS NOT NULL AND [销售净利率_立项版] IS NOT NULL
--         THEN ISNULL([销售净利率_立项版], 0) - isnull(lczy.[销售净利率-动态版],  pf.[销售净利率_动态版] )
--     END AS [销售净利率偏差],

--     isnull(lczy.[税后利润-动态版],pf.[税后利润_动态版] ) as [税后利润_动态版],
--     [税后利润_立项版],
--     CASE 
--         WHEN [税后利润_动态版] IS NOT NULL AND [税后利润_立项版] IS NOT NULL
--         THEN ISNULL([税后利润_立项版], 0) - isnull(lczy.[税后利润-动态版],pf.[税后利润_动态版] ) 
--     END AS [税后利润偏差],

--     [留存资产_动态版],
--     [留存资产_立项版],
--     isnull(lczy.[税后现金利润-动态版], pf.[税后现金利润_动态版] ) as [税后现金利润_动态版],
--     [税后现金利润_立项版],
--     CASE 
--         WHEN [税后现金利润_动态版] IS NOT NULL AND [税后现金利润_立项版] IS NOT NULL
--         THEN ISNULL([税后现金利润_立项版], 0) - isnull(lczy.[税后现金利润-动态版], pf.[税后现金利润_动态版] )
--     END AS [税后现金利润偏差],

--     [已实现税后利润_动态版],
--     [已实现销售净利率_动态版],
--     [未实现税后利润_动态版]
-- FROM zb_jyjhtjkb_Profit pf
-- left join  data_tb_ylss_lczy lczy on pf.projguid =lczy.项目GUID
-- WHERE
--     DATEDIFF(DAY, [清洗日期], ${qxDate} ) = 0

-- -- data_tb_ylss_lczy


-- 住宅总货值金额
-- 车位总货值金额
-- 总货值-动态版
-- 除地价外直投本月拍照版
-- 除地价外直投可售单方成本-动态版
-- 财务费用(单利)截止本月
-- 营销费用-动态版
-- 管理费用-动态版
-- 总投资-动态版
-- 增值税及附加-动态版
-- 税前成本利润率-动态版
-- 税前利润-动态版
-- 销售净利率-动态版
-- 税后利润-动态版
-- 税后现金利润-动态版
-- 全投资IRR-动态版
-- 现金流回正时间-动态版
-- 现金流回正时长-动态版