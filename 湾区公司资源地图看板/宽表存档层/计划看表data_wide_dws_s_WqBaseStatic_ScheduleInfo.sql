/***********************************************************************************************
 * 预处理及多层级里程碑数据宽表生成脚本
 * 
 * 本脚本处理湾区公司资源地图看板宽表存档层，按组织架构关系，逐层级统计并聚合计划/实际里程碑、面积等指标。
 * 各层级数据通过临时表递归汇总，最终以宽表形式输出。
 **********************************************************************************************/

-- 1. 先预处理停工标识，方便后续 join
SELECT 
    sb.gcbldguid, 
    sb.salebldguid, 
    zt.是否停工 
INTO #isstop
FROM 
    mdm_salebuild sb 
    LEFT JOIN MyCost_Erp352.dbo.p_HkbBiddingBuilding2BuildingWork b 
        ON sb.gcbldguid = b.BuildingGUID
    LEFT JOIN MyCost_Erp352.dbo.vp_HkbBiddingBuildingWork c 
        ON b.BudGUID = c.BuildGUID 
    LEFT JOIN MyCost_Erp352.dbo.jd_PlanTaskExecuteObjectForReport zt 
        ON zt.ztguid = b.BudGUID;

-----------------------------------------------------------------------------------------------
-- 2. 插入产品楼栋（组织架构类型7）数据，聚合面积与里程碑信息
-----------------------------------------------------------------------------------------------

SELECT 
    o.项目guid,
    o.组织架构ID,
    o.组织架构名称,
    o.组织架构类型,
    o.组织架构编码,

    -- 各类节点时间
    t.实际开工计划完成时间,
    t.实际开工预计完成时间,
    t.实际开工实际完成时间,
    t.实际开工集团里程碑时间,
    t.正式开工计划完成时间,
    t.正式开工预计完成时间,
    t.正式开工实际完成时间,
    t.正式开工集团里程碑时间,
    t.预售形象计划完成时间,
    t.预售形象预计完成时间,
    t.预售形象实际完成时间,
    t.预售形象集团里程碑时间,
    t.预售办理计划完成时间,
    t.预售办理预计完成时间,
    t.预售办理实际完成时间,
    t.预售办理集团里程碑时间,
    t.项目开盘计划完成时间,
    t.项目开盘预计完成时间,
    t.项目开盘实际完成时间,
    t.竣工备案计划完成时间,
    t.竣工备案预计完成时间,
    t.竣工备案实际完成时间,
    t.竣工备案集团里程碑时间,
    t.集中交付计划完成时间,
    t.集中交付预计完成时间,	
    t.集中交付实际完成时间,
    t.收回股东投资集团里程碑时间,
    t.收回股东投资实际完成时间,
    t.现金流回正集团里程碑时间,
    t.现金流回正实际完成时间,

    -- 面积各指标（本月、本年、明年、累计），均为计划、实际、期初、期末等
    -- 本月相关指标
    t.本月计划开工面积,
    t.本月计划竣工面积,
    t.本月初计划在建面积 + t.本月计划开工面积 - t.本月计划竣工面积 AS 本月计划在建面积,
    t.本月实际开工面积,
    t.本月实际竣工面积,
    t.本月初实际在建面积 + t.本月实际开工面积 - t.本月实际竣工面积 AS 本月实际在建面积, 
    -- 本年
    t.本年计划开工面积,
    t.本年计划竣工面积,
    t.本年初计划在建面积 + t.本年计划开工面积 - t.本年计划竣工面积 AS 本年计划在建面积,
    t.本年实际开工面积,
    t.本年实际竣工面积,
    t.本年初实际在建面积 + t.本年实际开工面积 - t.本年实际竣工面积 AS 本年实际在建面积, 
    -- 明年
    t.明年计划开工面积,
    t.明年计划竣工面积,
    t.本年初计划在建面积 + t.本年计划开工面积 - t.本年实际竣工面积 + t.明年计划开工面积 - t.明年计划竣工面积 AS 明年计划在建面积,
    -- 累计
    t.累计计划开工面积,
    t.累计计划竣工面积,
    t.累计计划开工面积 - t.累计计划竣工面积 AS 累计计划在建面积,
    t.累计实际开工面积,
    t.累计实际竣工面积,
    t.累计实际开工面积 - t.累计实际竣工面积 AS 累计实际在建面积,

    -- 停工标识
    t.是否停工
INTO #temp_result
FROM 
    [172.16.4.161].highdata_prod.dbo.data_wide_dws_s_WqBaseStatic_Organization o
    LEFT JOIN (
        -- 里程碑节点、面积等明细（统计到产品楼栋层）
        SELECT 
            组织架构id,
            实际开工计划完成时间,	实际开工预计完成时间,	
            实际开工实际完成时间,实际开工集团里程碑时间,正式开工计划完成时间,正式开工预计完成时间,
            正式开工实际完成时间,正式开工集团里程碑时间,预售形象计划完成时间,预售形象预计完成时间,
            预售形象实际完成时间,预售形象集团里程碑时间,预售办理计划完成时间,预售办理预计完成时间,
            预售办理实际完成时间,预售办理集团里程碑时间,项目开盘计划完成时间,项目开盘实际完成时间,项目开盘预计完成时间,
            竣工备案计划完成时间,竣工备案预计完成时间,	竣工备案实际完成时间,竣工备案集团里程碑时间,
            集中交付计划完成时间,集中交付预计完成时间,	集中交付实际完成时间,
            收回股东投资集团里程碑时间,	收回股东投资实际完成时间,	现金流回正集团里程碑时间,	现金流回正实际完成时间,

            -- 各类指标计算逻辑见 select 字段内注释
            sum(CASE 
                    -- 本月初计划在建面积
                    WHEN DATEDIFF(mm, ISNULL(ISNULL(实际开工实际完成时间, ISNULL(实际开工预计完成时间, 实际开工计划完成时间)), '2099-12-31'), GETDATE()) > 0
                     AND DATEDIFF(mm, ISNULL(ISNULL(竣工备案实际完成时间, ISNULL(竣工备案预计完成时间, 竣工备案计划完成时间)), '2099-12-31'), GETDATE()) <= 0
                        THEN ISNULL(sb.UpBuildArea,0)+ ISNULL(sb.DownBuildArea,0) 
                    ELSE 0  
                END) AS 本月初计划在建面积,
            sum(CASE 
                    -- 本月计划开工面积
                    WHEN DATEDIFF(mm, ISNULL(实际开工实际完成时间, ISNULL(实际开工预计完成时间, 实际开工计划完成时间)), GETDATE())=0 
                        THEN ISNULL(sb.UpBuildArea,0)+ ISNULL(sb.DownBuildArea,0) 
                    ELSE 0  
                END) AS 本月计划开工面积,	
            sum(CASE 
                    -- 本月计划竣工面积
                    WHEN DATEDIFF(mm, ISNULL(竣工备案实际完成时间, ISNULL(竣工备案预计完成时间, 竣工备案计划完成时间)), GETDATE())=0
                        THEN ISNULL(sb.UpBuildArea,0)+ ISNULL(sb.DownBuildArea,0) 
                    ELSE 0  
                END) AS 本月计划竣工面积,
            sum(CASE 
                    -- 本月初实际在建面积
                    WHEN DATEDIFF(mm, ISNULL(实际开工实际完成时间, '2099-12-31'), GETDATE()) > 0
                     AND DATEDIFF(mm, ISNULL(竣工备案实际完成时间, '2099-12-31'), GETDATE()) <= 0
                        THEN ISNULL(sb.UpBuildArea,0)+ ISNULL(sb.DownBuildArea,0) 
                    ELSE 0
                END) AS 本月初实际在建面积,
            sum(CASE 
                    -- 本月实际开工面积
                    WHEN DATEDIFF(mm, ISNULL(实际开工实际完成时间, '2099-12-31'), GETDATE())=0 
                        THEN ISNULL(sb.UpBuildArea,0)+ ISNULL(sb.DownBuildArea,0) 
                    ELSE 0 
                END) AS 本月实际开工面积,
            sum(CASE 
                    -- 本月实际竣工面积
                    WHEN DATEDIFF(mm, ISNULL(竣工备案实际完成时间, '2099-12-31'), GETDATE())=0 
                        THEN ISNULL(sb.UpBuildArea,0)+ ISNULL(sb.DownBuildArea,0) 
                    ELSE 0 
                END) AS 本月实际竣工面积,
            sum(CASE 
                    -- 本年初计划在建面积
                    WHEN DATEDIFF(yy, ISNULL(ISNULL(实际开工实际完成时间, ISNULL(实际开工预计完成时间, 实际开工计划完成时间)), '2099-12-31'), GETDATE()) > 0
                     AND DATEDIFF(yy, ISNULL(ISNULL(竣工备案实际完成时间, ISNULL(竣工备案预计完成时间, 竣工备案计划完成时间)), '2099-12-31'), GETDATE()) <= 0
                        THEN ISNULL(sb.UpBuildArea,0)+ ISNULL(sb.DownBuildArea,0) 
                    ELSE 0 
                END) AS 本年初计划在建面积,
            sum(CASE 
                    -- 本年计划开工面积
                    WHEN DATEDIFF(yy, ISNULL(实际开工实际完成时间, ISNULL(实际开工预计完成时间, 实际开工计划完成时间)), GETDATE())=0 
                        THEN ISNULL(sb.UpBuildArea,0)+ ISNULL(sb.DownBuildArea,0) 
                    ELSE 0
                END) AS 本年计划开工面积,
            sum(CASE 
                    -- 本年计划竣工面积
                    WHEN DATEDIFF(yy, ISNULL(竣工备案实际完成时间, ISNULL(竣工备案预计完成时间, 竣工备案计划完成时间)), GETDATE())=0 
                        THEN ISNULL(sb.UpBuildArea,0)+ ISNULL(sb.DownBuildArea,0) 
                    ELSE 0
                END) AS 本年计划竣工面积,
            sum(CASE 
                    -- 本年初实际在建面积
                    WHEN DATEDIFF(yy, ISNULL(实际开工实际完成时间, '2099-12-31'), GETDATE()) > 0
                     AND DATEDIFF(yy, ISNULL(竣工备案实际完成时间,'2099-12-31'), GETDATE()) <= 0
                        THEN ISNULL(sb.UpBuildArea,0)+ ISNULL(sb.DownBuildArea,0)
                    ELSE 0
                END) AS 本年初实际在建面积,
            sum(CASE 
                    -- 本年实际开工面积
                    WHEN DATEDIFF(yy, ISNULL(实际开工实际完成时间, '2099-12-31'), GETDATE())=0
                        THEN ISNULL(sb.UpBuildArea,0)+ ISNULL(sb.DownBuildArea,0) 
                    ELSE 0 
                END) AS 本年实际开工面积,
            sum(CASE 
                    -- 本年实际竣工面积
                    WHEN DATEDIFF(yy, ISNULL(竣工备案实际完成时间, '2099-12-31'), GETDATE())=0 
                        THEN ISNULL(sb.UpBuildArea,0)+ ISNULL(sb.DownBuildArea,0) 
                    ELSE 0
                END) AS 本年实际竣工面积,
            sum(CASE 
                    -- 明年计划开工面积（跨年度 = -1）
                    WHEN DATEDIFF(yy, ISNULL(实际开工实际完成时间, ISNULL(实际开工预计完成时间, 实际开工计划完成时间)), GETDATE()) = -1
                        THEN ISNULL(sb.UpBuildArea,0) + ISNULL(sb.DownBuildArea,0)
                    ELSE 0
                END) AS 明年计划开工面积,
            sum(CASE 
                    -- 明年计划竣工面积
                    WHEN DATEDIFF(yy, ISNULL(竣工备案实际完成时间, ISNULL(竣工备案预计完成时间, 竣工备案计划完成时间)), GETDATE()) = -1
                        THEN ISNULL(sb.UpBuildArea,0)+ ISNULL(sb.DownBuildArea,0) 
                    ELSE 0
                END) AS 明年计划竣工面积,
            sum(ISNULL(sb.UpBuildArea,0)+ISNULL(sb.DownBuildArea,0)) AS 累计计划开工面积,
            sum(ISNULL(sb.UpBuildArea,0)+ISNULL(sb.DownBuildArea,0)) AS 累计计划竣工面积,
            sum(CASE WHEN 实际开工实际完成时间 IS NOT NULL THEN ISNULL(sb.UpBuildArea,0)+ISNULL(sb.DownBuildArea,0) ELSE 0 END) AS 累计实际开工面积,
            sum(CASE WHEN 竣工备案实际完成时间 IS NOT NULL THEN ISNULL(sb.UpBuildArea,0)+ISNULL(sb.DownBuildArea,0) ELSE 0 END) AS 累计实际竣工面积,

            -- 停工标识
            st.是否停工
        FROM 
            ydkb_dthz_wq_deal_schedule jd
            INNER JOIN mdm_SaleBuild sb ON jd.组织架构ID = sb.SaleBldGUID
            LEFT JOIN #isstop st ON st.salebldguid = jd.组织架构id
        WHERE 
            组织架构类型 = 6     -- 只处理产品楼栋
        GROUP BY 
            组织架构id, 
            实际开工计划完成时间, 实际开工预计完成时间, 实际开工实际完成时间, 实际开工集团里程碑时间,
            正式开工计划完成时间, 正式开工预计完成时间, 正式开工实际完成时间, 正式开工集团里程碑时间,
            预售形象计划完成时间, 预售形象预计完成时间, 预售形象实际完成时间, 预售形象集团里程碑时间,
            预售办理计划完成时间, 预售办理预计完成时间, 预售办理实际完成时间, 预售办理集团里程碑时间,
            项目开盘计划完成时间, 项目开盘实际完成时间, 项目开盘预计完成时间,
            竣工备案计划完成时间, 竣工备案预计完成时间, 竣工备案实际完成时间, 竣工备案集团里程碑时间,
            集中交付计划完成时间, 集中交付预计完成时间, 集中交付实际完成时间,
            收回股东投资集团里程碑时间, 收回股东投资实际完成时间, 现金流回正集团里程碑时间, 现金流回正实际完成时间,
            st.是否停工
    ) t ON o.组织架构id = t.组织架构id
WHERE 
    o.组织架构类型 = 7    -- 产品楼栋


-----------------------------------------------------------------------------------------------
-- 3. 处理工程楼栋（组织架构类型6），面积指标需向上汇总至产品楼栋
-----------------------------------------------------------------------------------------------

INSERT INTO #temp_result
SELECT  
    o.项目guid, o.组织架构ID, o.组织架构名称, o.组织架构类型, o.组织架构编码,
    t.实际开工计划完成时间, t.实际开工预计完成时间, t.实际开工实际完成时间, t.实际开工集团里程碑时间,
    t.正式开工计划完成时间, t.正式开工预计完成时间, t.正式开工实际完成时间, t.正式开工集团里程碑时间,
    t.预售形象计划完成时间, t.预售形象预计完成时间, t.预售形象实际完成时间, t.预售形象集团里程碑时间,
    t.预售办理计划完成时间, t.预售办理预计完成时间, t.预售办理实际完成时间, t.预售办理集团里程碑时间,
    t.项目开盘计划完成时间, t.项目开盘实际完成时间, t.项目开盘预计完成时间,
    t.竣工备案计划完成时间, t.竣工备案预计完成时间, t.竣工备案实际完成时间, t.竣工备案集团里程碑时间,
    t.集中交付计划完成时间, t.集中交付预计完成时间, t.集中交付实际完成时间,
    t.收回股东投资集团里程碑时间, t.收回股东投资实际完成时间, t.现金流回正集团里程碑时间, t.现金流回正实际完成时间,

    -- 各面积指标为其下属“产品楼栋”聚合
    sum(re.本月计划开工面积) as 本月计划开工面积,
    sum(re.本月计划竣工面积) as 本月计划竣工面积,
    sum(re.本月计划在建面积) as 本月计划在建面积,
    sum(re.本月实际开工面积) as 本月实际开工面积,
    sum(re.本月实际竣工面积) as 本月实际竣工面积,
    sum(re.本月实际在建面积) as 本月实际在建面积,

    sum(re.本年计划开工面积) as 本年计划开工面积,
    sum(re.本年计划竣工面积) as 本年计划竣工面积,
    sum(re.本年计划在建面积) as 本年计划在建面积,
    sum(re.本年实际开工面积) as 本年实际开工面积,
    sum(re.本年实际竣工面积) as 本年实际竣工面积,
    sum(re.本年实际在建面积) as 本年实际在建面积,

    sum(re.明年计划开工面积) as 明年计划开工面积,
    sum(re.明年计划竣工面积) as 明年计划竣工面积,
    sum(re.明年计划在建面积) as 明年计划在建面积,

    sum(re.累计计划开工面积) as 累计计划开工面积,
    sum(re.累计计划竣工面积) as 累计计划竣工面积,
    sum(re.累计计划在建面积) as 累计计划在建面积,
    sum(re.累计实际开工面积) as 累计实际开工面积,
    sum(re.累计实际竣工面积) as 累计实际竣工面积,
    sum(re.累计实际在建面积) as 累计实际在建面积,

    t.是否停工
FROM 
    [172.16.4.161].highdata_prod.dbo.data_wide_dws_s_WqBaseStatic_Organization o
    LEFT JOIN (
        -- 工程楼栋里程碑与是否停工标识
        SELECT DISTINCT 
            组织架构id,
            实际开工计划完成时间, 实际开工预计完成时间, 
            实际开工实际完成时间, 实际开工集团里程碑时间, 
            正式开工计划完成时间, 正式开工预计完成时间, 正式开工实际完成时间, 正式开工集团里程碑时间,
            预售形象计划完成时间, 预售形象预计完成时间, 预售形象实际完成时间, 预售形象集团里程碑时间,
            预售办理计划完成时间, 预售办理预计完成时间, 预售办理实际完成时间, 预售办理集团里程碑时间,
            项目开盘计划完成时间, 项目开盘实际完成时间, 项目开盘预计完成时间,
            竣工备案计划完成时间, 竣工备案预计完成时间, 竣工备案实际完成时间, 竣工备案集团里程碑时间,
            集中交付计划完成时间, 集中交付预计完成时间, 集中交付实际完成时间,
            收回股东投资集团里程碑时间, 收回股东投资实际完成时间, 现金流回正集团里程碑时间, 现金流回正实际完成时间,
            st.是否停工
        FROM 
            ydkb_dthz_wq_deal_schedule jd 
            LEFT JOIN #isstop st ON st.gcbldguid = jd.组织架构id
        WHERE 
            组织架构类型 = 5 -- 工程楼栋
    ) t ON o.工程楼栋id = t.组织架构id 
    INNER JOIN [172.16.4.161].highdata_prod.dbo.data_wide_dws_s_WqBaseStatic_Organization o1 
        ON o1.组织架构父级id = o.组织架构id 
    LEFT JOIN #temp_result re 
        ON re.组织架构id = o1.组织架构id AND re.组织架构类型 = 7
WHERE 
    o.组织架构类型 = 6
GROUP BY  
    o.项目guid, o.组织架构ID, o.组织架构名称, o.组织架构类型, o.组织架构编码,
    t.实际开工计划完成时间, t.实际开工预计完成时间, t.实际开工实际完成时间, t.实际开工集团里程碑时间,
    t.正式开工计划完成时间, t.正式开工预计完成时间, t.正式开工实际完成时间, t.正式开工集团里程碑时间,
    t.预售形象计划完成时间, t.预售形象预计完成时间, t.预售形象实际完成时间, t.预售形象集团里程碑时间,
    t.预售办理计划完成时间, t.预售办理预计完成时间, t.预售办理实际完成时间, t.预售办理集团里程碑时间,
    t.项目开盘计划完成时间, t.项目开盘实际完成时间, t.项目开盘预计完成时间,
    t.竣工备案计划完成时间, t.竣工备案预计完成时间, t.竣工备案实际完成时间, t.竣工备案集团里程碑时间,
    t.集中交付计划完成时间, t.集中交付预计完成时间, t.集中交付实际完成时间,
    t.收回股东投资集团里程碑时间, t.收回股东投资实际完成时间, t.现金流回正集团里程碑时间, t.现金流回正实际完成时间,
    t.是否停工

-----------------------------------------------------------------------------------------------
-- 4. 项目层级（组织架构类型3）里程碑节点需保留，面积通过产品向上递归聚合，继续循环更新区域、公司层级
-----------------------------------------------------------------------------------------------

INSERT INTO #temp_result
SELECT 
    o.项目guid, o.组织架构ID, o.组织架构名称, o.组织架构类型, o.组织架构编码,
    t.实际开工计划完成时间, t.实际开工预计完成时间, t.实际开工实际完成时间, t.实际开工集团里程碑时间,
    t.正式开工计划完成时间, t.正式开工预计完成时间, t.正式开工实际完成时间, t.正式开工集团里程碑时间,
    t.预售形象计划完成时间, t.预售形象预计完成时间, t.预售形象实际完成时间, t.预售形象集团里程碑时间,
    t.预售办理计划完成时间, t.预售办理预计完成时间, t.预售办理实际完成时间, t.预售办理集团里程碑时间,
    t.项目开盘计划完成时间, t.项目开盘实际完成时间, t.项目开盘预计完成时间,
    t.竣工备案计划完成时间, t.竣工备案预计完成时间, t.竣工备案实际完成时间, t.竣工备案集团里程碑时间,
    t.集中交付计划完成时间, t.集中交付预计完成时间, t.集中交付实际完成时间,
    t.收回股东投资集团里程碑时间, t.收回股东投资实际完成时间, t.现金流回正集团里程碑时间, t.现金流回正实际完成时间,

    -- 面积递归汇总
    sum(re.本月计划开工面积) as 本月计划开工面积,
    sum(re.本月计划竣工面积) as 本月计划竣工面积,
    sum(re.本月计划在建面积) as 本月计划在建面积,
    sum(re.本月实际开工面积) as 本月实际开工面积,
    sum(re.本月实际竣工面积) as 本月实际竣工面积,
    sum(re.本月实际在建面积) as 本月实际在建面积,

    sum(re.本年计划开工面积) as 本年计划开工面积,
    sum(re.本年计划竣工面积) as 本年计划竣工面积,
    sum(re.本年计划在建面积) as 本年计划在建面积,
    sum(re.本年实际开工面积) as 本年实际开工面积,
    sum(re.本年实际竣工面积) as 本年实际竣工面积,
    sum(re.本年实际在建面积) as 本年实际在建面积,

    sum(re.明年计划开工面积) as 明年计划开工面积,
    sum(re.明年计划竣工面积) as 明年计划竣工面积,
    sum(re.明年计划在建面积) as 明年计划在建面积,

    sum(re.累计计划开工面积) as 累计计划开工面积,
    sum(re.累计计划竣工面积) as 累计计划竣工面积,
    sum(re.累计计划在建面积) as 累计计划在建面积,
    sum(re.累计实际开工面积) as 累计实际开工面积,
    sum(re.累计实际竣工面积) as 累计实际竣工面积,
    sum(re.累计实际在建面积) as 累计实际在建面积,

    NULL as 是否停工     -- 项目/公司级无直接停工标识
FROM 
    [172.16.4.161].highdata_prod.dbo.data_wide_dws_s_WqBaseStatic_Organization o
    LEFT JOIN (
        -- 项目层级节点时间
        SELECT 
            组织架构id, 实际开工计划完成时间, 实际开工预计完成时间, 实际开工实际完成时间, 实际开工集团里程碑时间,
            正式开工计划完成时间, 正式开工预计完成时间, 正式开工实际完成时间, 正式开工集团里程碑时间,
            预售形象计划完成时间, 预售形象预计完成时间, 预售形象实际完成时间, 预售形象集团里程碑时间,
            预售办理计划完成时间, 预售办理预计完成时间, 预售办理实际完成时间, 预售办理集团里程碑时间,
            项目开盘计划完成时间, 项目开盘实际完成时间, 项目开盘预计完成时间,
            竣工备案计划完成时间, 竣工备案预计完成时间, 竣工备案实际完成时间, 竣工备案集团里程碑时间,
            集中交付计划完成时间, 集中交付预计完成时间, 集中交付实际完成时间,
            收回股东投资集团里程碑时间, 收回股东投资实际完成时间, 现金流回正集团里程碑时间, 现金流回正实际完成时间
        FROM 
            ydkb_dthz_wq_deal_schedule jd 
        WHERE 
            组织架构类型 = 3
    ) t ON o.组织架构id = t.组织架构id
    LEFT JOIN #temp_result re 
        ON re.项目guid = o.组织架构id AND re.组织架构类型=6
WHERE 
    o.组织架构类型 = 3    -- 只处理项目层级
GROUP BY 
    o.项目guid, o.组织架构ID, o.组织架构名称, o.组织架构类型, o.组织架构编码,
    t.实际开工计划完成时间, t.实际开工预计完成时间, t.实际开工实际完成时间, t.实际开工集团里程碑时间,
    t.正式开工计划完成时间, t.正式开工预计完成时间, t.正式开工实际完成时间, t.正式开工集团里程碑时间,
    t.预售形象计划完成时间, t.预售形象预计完成时间, t.预售形象实际完成时间, t.预售形象集团里程碑时间,
    t.预售办理计划完成时间, t.预售办理预计完成时间, t.预售办理实际完成时间, t.预售办理集团里程碑时间,
    t.项目开盘计划完成时间, t.项目开盘实际完成时间, t.项目开盘预计完成时间,
    t.竣工备案计划完成时间, t.竣工备案预计完成时间, t.竣工备案实际完成时间, t.竣工备案集团里程碑时间,
    t.集中交付计划完成时间, t.集中交付预计完成时间, t.集中交付实际完成时间,
    t.收回股东投资集团里程碑时间, t.收回股东投资实际完成时间, t.现金流回正集团里程碑时间, t.现金流回正实际完成时间

-----------------------------------------------------------------------------------------------
-- 5. 循环递归区域、公司层级（组织架构类型 5～1）面积汇总，跳过项目层级（类型3）
-----------------------------------------------------------------------------------------------

DECLARE @baseinfo INT 
SET @baseinfo = 5

WHILE (@baseinfo > 0)
BEGIN 
    IF (@baseinfo = 3) 
    BEGIN 
        SET @baseinfo = @baseinfo - 1
        CONTINUE -- 跳过项目层级汇总，避免重复
    END 

    -- 按父级递归向上汇总面积
    INSERT INTO #temp_result
    SELECT 
        o.项目guid, o.组织架构ID, o.组织架构名称, o.组织架构类型, o.组织架构编码,

        -- 上层节点时间设 Null
        NULL AS 实际开工计划完成时间,	NULL AS 实际开工预计完成时间,	
        NULL AS 实际开工实际完成时间, NULL AS 实际开工集团里程碑时间, 
        NULL AS 正式开工计划完成时间, NULL AS 正式开工预计完成时间, 
        NULL AS 正式开工实际完成时间, NULL AS 正式开工集团里程碑时间, 
        NULL AS 预售形象计划完成时间, NULL AS 预售形象预计完成时间,
        NULL AS 预售形象实际完成时间, NULL AS 预售形象集团里程碑时间,
        NULL AS 预售办理计划完成时间, NULL AS 预售办理预计完成时间,
        NULL AS 预售办理实际完成时间, NULL AS 预售办理集团里程碑时间,
        NULL AS 项目开盘计划完成时间, NULL AS 项目开盘实际完成时间, NULL AS 项目开盘预计完成时间,
        NULL AS 竣工备案计划完成时间, NULL AS 竣工备案预计完成时间, NULL AS 竣工备案实际完成时间, NULL AS 竣工备案集团里程碑时间,
        NULL AS 集中交付计划完成时间, NULL AS 集中交付预计完成时间, NULL AS 集中交付实际完成时间,
        NULL AS 收回股东投资集团里程碑时间, NULL AS 收回股东投资实际完成时间, NULL AS 现金流回正集团里程碑时间, NULL AS 现金流回正实际完成时间,

        -- 下属节点面积递归求和
        SUM(re.本月计划开工面积) AS 本月计划开工面积,
        SUM(re.本月计划竣工面积) AS 本月计划竣工面积,
        SUM(re.本月计划在建面积) AS 本月计划在建面积,
        SUM(re.本月实际开工面积) AS 本月实际开工面积,
        SUM(re.本月实际竣工面积) AS 本月实际竣工面积,
        SUM(re.本月实际在建面积) AS 本月实际在建面积,

        SUM(re.本年计划开工面积) AS 本年计划开工面积,
        SUM(re.本年计划竣工面积) AS 本年计划竣工面积,
        SUM(re.本年计划在建面积) AS 本年计划在建面积,
        SUM(re.本年实际开工面积) AS 本年实际开工面积,
        SUM(re.本年实际竣工面积) AS 本年实际竣工面积,
        SUM(re.本年实际在建面积) AS 本年实际在建面积,

        SUM(re.明年计划开工面积) AS 明年计划开工面积,
        SUM(re.明年计划竣工面积) AS 明年计划竣工面积,
        SUM(re.明年计划在建面积) AS 明年计划在建面积,

        SUM(re.累计计划开工面积) AS 累计计划开工面积,
        SUM(re.累计计划竣工面积) AS 累计计划竣工面积,
        SUM(re.累计计划在建面积) AS 累计计划在建面积,
        SUM(re.累计实际开工面积) AS 累计实际开工面积,
        SUM(re.累计实际竣工面积) AS 累计实际竣工面积,
        SUM(re.累计实际在建面积) AS 累计实际在建面积,

        NULL AS 是否停工
    FROM 
        [172.16.4.161].highdata_prod.dbo.data_wide_dws_s_WqBaseStatic_Organization o 
        INNER JOIN [172.16.4.161].highdata_prod.dbo.data_wide_dws_s_WqBaseStatic_Organization o1 
                ON o1.组织架构父级id = o.组织架构id
        LEFT JOIN #temp_result re ON re.组织架构id = o1.组织架构id  
    WHERE 
        o.组织架构类型 = @baseinfo
    GROUP BY 
        o.项目guid, o.组织架构ID, o.组织架构名称, o.组织架构类型, o.组织架构编码

    SET @baseinfo = @baseinfo - 1
END

-----------------------------------------------------------------------------------------------
-- 6. 最终输出宽表
-----------------------------------------------------------------------------------------------

SELECT 
    组织架构ID,
    组织架构名称,
    组织架构类型,
    组织架构编码,

    -- 里程碑各节点
    实际开工计划完成时间,	 实际开工预计完成时间,	
    实际开工实际完成时间, 实际开工集团里程碑时间, 
    正式开工计划完成时间, 正式开工预计完成时间, 正式开工实际完成时间, 正式开工集团里程碑时间, 
    预售形象计划完成时间, 预售形象预计完成时间, 预售形象实际完成时间, 预售形象集团里程碑时间,
    预售办理计划完成时间, 预售办理预计完成时间, 预售办理实际完成时间, 预售办理集团里程碑时间,
    项目开盘计划完成时间, 项目开盘实际完成时间, 项目开盘预计完成时间,
    竣工备案计划完成时间, 竣工备案预计完成时间, 竣工备案实际完成时间, 竣工备案集团里程碑时间,
    集中交付计划完成时间, 集中交付预计完成时间, 集中交付实际完成时间,
    收回股东投资集团里程碑时间, 收回股东投资实际完成时间, 现金流回正集团里程碑时间, 现金流回正实际完成时间,

    -- 面积各类指标（计划、实际、期初、累计等）
    本月计划开工面积,
    本月计划竣工面积,
    本月计划在建面积,
    本月实际开工面积,
    本月实际竣工面积,
    本月实际在建面积, 
    本年计划开工面积,
    本年计划竣工面积,
    本年计划在建面积,
    本年实际开工面积,
    本年实际竣工面积,
    本年实际在建面积, 
    明年计划开工面积,
    明年计划竣工面积,
    明年计划在建面积,
    累计计划开工面积,
    累计计划竣工面积,
    累计计划在建面积,
    累计实际开工面积,
    累计实际竣工面积,
    累计实际在建面积,

    是否停工  -- 仅到产品楼栋/工程楼栋层有标识
FROM #temp_result    

-----------------------------------------------------------------------------------------------
-- 7. 清理临时表
-----------------------------------------------------------------------------------------------

DROP TABLE #temp_result

